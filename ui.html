<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Self-Check Design Assistant</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 12px;
            line-height: 1.4;
            color: var(--figma-color-text);
            background: var(--figma-color-bg);
            padding: 16px;
        }
        
        .header {
            background: var(--figma-color-bg-brand);
            color: var(--figma-color-text-onbrand);
            padding: 12px 16px;
            margin: -16px -16px 16px -16px;
            border-radius: 8px 8px 0 0;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }
        
        .section {
            margin-bottom: 20px;
        }
        
        .section-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--figma-color-text);
            font-size: 13px;
        }
        
        .selection-info {
            background: var(--figma-color-bg-secondary);
            border: 1px solid var(--figma-color-border);
            border-radius: 6px;
            padding: 12px;
            min-height: 80px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 10px;
            line-height: 1.4;
            color: var(--figma-color-text-secondary);
        }
        
        .selection-info.empty {
            color: var(--figma-color-text-disabled);
            font-style: italic;
        }
        
        .button-group {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .button {
            flex: 1;
            background: var(--figma-color-bg-brand);
            color: var(--figma-color-text-onbrand);
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .button:hover:not(:disabled) {
            background: var(--figma-color-bg-brand-hover);
        }
        
        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .button.secondary {
            background: var(--figma-color-bg-secondary);
            color: var(--figma-color-text);
            border: 1px solid var(--figma-color-border);
        }
        
        .button.secondary:hover:not(:disabled) {
            background: var(--figma-color-bg-hover);
        }
        
        .result-container {
            background: var(--figma-color-bg-secondary);
            border: 1px solid var(--figma-color-border);
            border-radius: 6px;
            min-height: 150px;
            position: relative;
            overflow: hidden;
        }
        
        .result-content {
            padding: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .loading {
            display: none;
            align-items: center;
            justify-content: center;
            height: 150px;
            color: var(--figma-color-text-secondary);
        }
        
        .loading.show {
            display: flex;
        }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--figma-color-border);
            border-top: 2px solid var(--figma-color-bg-brand);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .result {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 11px;
            line-height: 1.5;
            white-space: pre-wrap;
            color: var(--figma-color-text-secondary);
        }
        
        .analysis-result {
            font-size: 12px;
            line-height: 1.5;
        }
        
        .score-badge {
            display: inline-block;
            background: var(--figma-color-bg-brand);
            color: var(--figma-color-text-onbrand);
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 11px;
            margin-bottom: 12px;
        }
        
        .score-good { background: #0d9488; }
        .score-medium { background: #d97706; }
        .score-poor { background: #dc2626; }
        
        .violations {
            margin-bottom: 16px;
        }
        
        .violation-item {
            background: var(--figma-color-bg);
            border: 1px solid var(--figma-color-border);
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 8px;
            border-left: 3px solid var(--figma-color-text-danger);
        }
        
        .violation-item.high {
            border-left-color: #dc2626;
        }
        
        .violation-item.medium {
            border-left-color: #d97706;
        }
        
        .violation-item.low {
            border-left-color: #65a30d;
        }
        
        .violation-header {
            font-weight: 600;
            font-size: 11px;
            color: var(--figma-color-text);
            margin-bottom: 4px;
        }
        
        .violation-text {
            font-size: 10px;
            color: var(--figma-color-text-secondary);
            margin-bottom: 4px;
        }
        
        .violation-fix {
            font-size: 10px;
            color: var(--figma-color-text-secondary);
            background: var(--figma-color-bg-secondary);
            padding: 4px 6px;
            border-radius: 3px;
            font-style: italic;
        }
        
        .recommendations {
            margin-bottom: 16px;
        }
        
        .recommendation-item {
            background: var(--figma-color-bg);
            border: 1px solid var(--figma-color-border);
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 8px;
            border-left: 3px solid var(--figma-color-bg-brand);
        }
        
        .recommendation-header {
            font-weight: 600;
            font-size: 11px;
            color: var(--figma-color-text);
            margin-bottom: 4px;
        }
        
        .recommendation-text {
            font-size: 10px;
            color: var(--figma-color-text-secondary);
            margin-bottom: 4px;
        }
        
        .recommendation-benefit {
            font-size: 10px;
            color: var(--figma-color-text-secondary);
            background: var(--figma-color-bg-secondary);
            padding: 4px 6px;
            border-radius: 3px;
            font-style: italic;
        }
        
        .positive-aspects {
            margin-bottom: 16px;
        }
        
        .positive-item {
            background: var(--figma-color-bg);
            border: 1px solid var(--figma-color-border);
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 6px;
            border-left: 3px solid #0d9488;
        }
        
        .positive-item-text {
            font-size: 10px;
            color: var(--figma-color-text-secondary);
        }
        
        .section-subtitle {
            font-weight: 600;
            font-size: 12px;
            color: var(--figma-color-text);
            margin-bottom: 8px;
        }
        
        .design-system-gaps {
            margin-bottom: 16px;
        }
        
        .gap-item {
            background: var(--figma-color-bg);
            border: 1px solid var(--figma-color-border);
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 6px;
            border-left: 3px solid #f59e0b;
        }
        
        .gap-text {
            font-size: 10px;
            color: var(--figma-color-text-secondary);
        }
        
        .violation-item.critical {
            border-left-color: #dc2626;
            background: rgba(220, 38, 38, 0.05);
        }
        
        .error {
            color: var(--figma-color-text-danger);
            font-weight: 500;
        }
        
        .empty-state {
            text-align: center;
            color: var(--figma-color-text-disabled);
            font-style: italic;
            padding: 40px 20px;
        }
        
        .close-button {
            position: absolute;
            bottom: 16px;
            right: 16px;
            background: var(--figma-color-bg-secondary);
            color: var(--figma-color-text);
            border: 1px solid var(--figma-color-border);
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 11px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        
        .close-button:hover {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="header">
        ğŸ¨ Self-Check Design Assistant
    </div>
    
    <div class="section">
        <div class="section-title">ì„ íƒëœ ìš”ì†Œ</div>
        <div id="selection-info" class="selection-info empty">
            ìš”ì†Œë¥¼ ì„ íƒí•˜ê³  í”ŒëŸ¬ê·¸ì¸ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.
        </div>
    </div>
    
    <div class="button-group">
        <button id="refresh-btn" class="button secondary">ìƒˆë¡œê³ ì¹¨</button>
        <button id="analyze-btn" class="button">ë¶„ì„ ì‹¤í–‰</button>
    </div>
    
    <div class="section">
        <div class="section-title">ë¶„ì„ ê²°ê³¼</div>
        <div class="result-container">
            <div id="loading" class="loading">
                <div class="spinner"></div>
                AI ë¶„ì„ ì¤‘...
            </div>
            <div id="result-content" class="result-content">
                <div class="empty-state">
                    ë¶„ì„ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë””ìì¸ ì›ì¹™ ê²€í† ë¥¼ ì‹œì‘í•˜ì„¸ìš”.
                </div>
            </div>
        </div>
    </div>
    
    <button id="close-btn" class="close-button">ë‹«ê¸°</button>

<script>
        // UI ìƒíƒœ ê´€ë¦¬
        const elements = {
            selectionInfo: document.getElementById('selection-info'),
            refreshBtn: document.getElementById('refresh-btn'),
            analyzeBtn: document.getElementById('analyze-btn'),
            loading: document.getElementById('loading'),
            resultContent: document.getElementById('result-content'),
            closeBtn: document.getElementById('close-btn')
        };
        
        let isAnalyzing = false;
        
        // ë¡œë”© ìƒíƒœ ì—…ë°ì´íŠ¸
        function setLoading(loading) {
            isAnalyzing = loading;
            elements.loading.classList.toggle('show', loading);
            elements.analyzeBtn.disabled = loading;
            elements.refreshBtn.disabled = loading;
            
            if (loading) {
                elements.resultContent.innerHTML = '';
            }
        }
        
        // ì„ íƒ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateSelectionInfo(info) {
            elements.selectionInfo.textContent = info;
            elements.selectionInfo.classList.toggle('empty', info === 'ì„ íƒëœ ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.');
        }
        
        // ì ìˆ˜ì— ë”°ë¥¸ í´ë˜ìŠ¤ ë°˜í™˜
        function getScoreClass(score) {
            const numScore = parseInt(score);
            // 100ì  ë§Œì ì¸ ê²½ìš°
            if (numScore > 10) {
                if (numScore >= 80) return 'score-good';
                if (numScore >= 60) return 'score-medium';
                return 'score-poor';
            }
            // 10ì  ë§Œì ì¸ ê²½ìš°
            if (numScore >= 8) return 'score-good';
            if (numScore >= 6) return 'score-medium';
            return 'score-poor';
        }
        
        // ë¶„ì„ ê²°ê³¼ë¥¼ HTMLë¡œ í¬ë§·íŒ…
        function formatAnalysisResult(result) {
            let html = '<div class="analysis-result">';
            
            // Flowise ì‹¤ì œ ì‘ë‹µ í˜•íƒœ ì²˜ë¦¬
            if (result.score && typeof result.score === 'object') {
                // ì „ì²´ ì ìˆ˜ í‘œì‹œ
                if (result.score.overall) {
                    const scoreClass = getScoreClass(result.score.overall);
                    html += `<div class="score-badge ${scoreClass}">ì „ì²´ ì ìˆ˜: ${result.score.overall}/100</div>`;
                }
                
                // ì„¸ë¶€ ì›ì¹™ë³„ ì ìˆ˜
                if (result.score.principles) {
                    html += '<div class="section-subtitle">ğŸ“Š ì›ì¹™ë³„ ì ìˆ˜</div>';
                    html += '<div style="margin-bottom: 16px;">';
                    Object.entries(result.score.principles).forEach(([principle, score]) => {
                        const scoreClass = getScoreClass(Number(score) * 10); // 10ì  ë§Œì ìœ¼ë¡œ ë³€í™˜
                        html += `<div style="display: inline-block; margin: 4px 8px 4px 0;">`;
                        html += `<span style="background: var(--figma-color-bg-secondary); padding: 2px 6px; border-radius: 4px; font-size: 10px;">${principle}: ${score}/10</span>`;
                        html += '</div>';
                    });
                    html += '</div>';
                }
            }
            
            // ìš”ì•½ ì •ë³´
            if (result.summary) {
                html += '<div class="section-subtitle">ğŸ“‹ ë¶„ì„ ìš”ì•½</div>';
                html += `<div style="padding: 8px; background: var(--figma-color-bg-secondary); border-radius: 4px; margin-bottom: 12px; font-size: 11px;">${result.summary}</div>`;
            }
            
            // ìœ„ë°˜ì‚¬í•­ (ë°°ì—´ í˜•íƒœ)
            if (result.violations && result.violations.length > 0) {
                html += '<div class="violations">';
                html += '<div class="section-subtitle">âš ï¸ ìœ„ë°˜ì‚¬í•­</div>';
                result.violations.forEach(violation => {
                    // violationì€ [element, principle, issue, severity, fix] í˜•íƒœ
                    const [element, principle, issue, severity, fix] = violation;
                    const severityClass = severity === 'high' ? 'high' : (severity === 'moderate' ? 'medium' : 'low');
                    
                    html += `<div class="violation-item ${severityClass}">`;
                    html += `<div class="violation-header">${principle} - ${element}</div>`;
                    html += `<div class="violation-text"><strong>ë¬¸ì œ:</strong> ${issue}</div>`;
                    if (fix) {
                        html += `<div class="violation-fix">ğŸ’¡ <strong>í•´ê²°ë°©ë²•:</strong> ${fix}</div>`;
                    }
                    html += '</div>';
                });
                html += '</div>';
            }
            
            // ì¤€ìˆ˜ì‚¬í•­ (ë°°ì—´ í˜•íƒœ)
            if (result.compliances && result.compliances.length > 0) {
                html += '<div class="positive-aspects">';
                html += '<div class="section-subtitle">âœ… ì¤€ìˆ˜ì‚¬í•­</div>';
                result.compliances.forEach(compliance => {
                    // complianceëŠ” [element, principle, reason, level] í˜•íƒœ
                    const [element, principle, reason, level] = compliance;
                    
                    html += '<div class="positive-item">';
                    html += `<div class="positive-item-text"><strong>${principle}:</strong> ${reason} (${element})</div>`;
                    html += '</div>';
                });
                html += '</div>';
            }
            
            // ì¶”ì²œì‚¬í•­ (ë°°ì—´ í˜•íƒœ)
            if (result.recommendations && result.recommendations.length > 0) {
                html += '<div class="recommendations">';
                html += '<div class="section-subtitle">ğŸ’¡ ì¶”ì²œì‚¬í•­</div>';
                result.recommendations.forEach(recommendation => {
                    // recommendationì€ [priority, suggestion, impact] í˜•íƒœ
                    const [priority, suggestion, impact] = recommendation;
                    const priorityBadge = priority === 'high' ? 'ğŸ”´' : (priority === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢');
                    
                    html += '<div class="recommendation-item">';
                    html += `<div class="recommendation-header">${priorityBadge} ${priority.toUpperCase()}</div>`;
                    html += `<div class="recommendation-text">${suggestion}</div>`;
                    if (impact) {
                        html += `<div class="recommendation-benefit">âœ¨ <strong>íš¨ê³¼:</strong> ${impact}</div>`;
                    }
                    html += '</div>';
                });
                html += '</div>';
            }
            
            // ê°„ë‹¨í•œ í˜•íƒœì˜ ì‘ë‹µ ì²˜ë¦¬ (ì´ì „ ë²„ì „ê³¼ì˜ í˜¸í™˜ì„±)
            if (result.score && typeof result.score === 'string' && (result.issues || result.suggestions)) {
                // ì ìˆ˜ í‘œì‹œ
                const scoreClass = getScoreClass(result.score);
                html += `<div class="score-badge ${scoreClass}">ì ìˆ˜: ${result.score}/10</div>`;
                
                // ë¬¸ì œì  í‘œì‹œ
                if (result.issues && result.issues.length > 0) {
                    html += '<div class="violations">';
                    html += '<div class="section-subtitle">âš ï¸ ë°œê²¬ëœ ë¬¸ì œì </div>';
                    result.issues.forEach(issue => {
                        html += `<div class="violation-item medium">`;
                        html += `<div class="violation-text">${issue}</div>`;
                        html += '</div>';
                    });
                    html += '</div>';
                }
                
                // ê°œì„  ì œì•ˆ í‘œì‹œ
                if (result.suggestions && result.suggestions.length > 0) {
                    html += '<div class="recommendations">';
                    html += '<div class="section-subtitle">ğŸ’¡ ê°œì„  ì œì•ˆ</div>';
                    result.suggestions.forEach(suggestion => {
                        html += '<div class="recommendation-item">';
                        html += `<div class="recommendation-text">${suggestion}</div>`;
                        html += '</div>';
                    });
                    html += '</div>';
                }
                
                html += '</div>';
                return html;
            }
            
            // ì‚¬ë‚´ ì›ì¹™ ì¤€ìˆ˜ ì ìˆ˜ (ì´ì „ ë²„ì „ê³¼ì˜ í˜¸í™˜ì„±)
            if (result.overall_compliance_score) {
                const scoreClass = getScoreClass(result.overall_compliance_score);
                html += `<div class="score-badge ${scoreClass}">ì‚¬ë‚´ ì›ì¹™ ì¤€ìˆ˜ ì ìˆ˜: ${result.overall_compliance_score}/10</div>`;
            }
            
            // ê¸°ì¡´ ìƒì„¸ êµ¬ì¡° ì²˜ë¦¬ (ì´ì „ ë²„ì „ê³¼ì˜ í˜¸í™˜ì„±)
            if (result.violations && result.violations.length > 0 && typeof result.violations[0] === 'object') {
                html += '<div class="violations">';
                html += '<div class="section-subtitle">âš ï¸ ì‚¬ë‚´ ê·œì¹™ ìœ„ë°˜ì‚¬í•­</div>';
                result.violations.forEach(violation => {
                    const severityClass = violation.severity === 'critical' ? 'high' : (violation.severity || 'medium');
                    html += `<div class="violation-item ${severityClass}">`;
                    html += `<div class="violation-header">${violation.category || 'ì¼ë°˜'} - ${violation.element || 'í•´ë‹¹ ìš”ì†Œ'}</div>`;
                    
                    if (violation.rule_violated) {
                        html += `<div class="violation-text"><strong>ìœ„ë°˜ ê·œì¹™:</strong> ${violation.rule_violated}</div>`;
                    }
                    
                    if (violation.current_state) {
                        html += `<div class="violation-text"><strong>í˜„ì¬ ìƒíƒœ:</strong> ${violation.current_state}</div>`;
                    }
                    
                    if (violation.required_state) {
                        html += `<div class="violation-text"><strong>ìš”êµ¬ ìƒíƒœ:</strong> ${violation.required_state}</div>`;
                    }
                    
                    if (violation.fix_action) {
                        html += `<div class="violation-fix">ğŸ’¡ <strong>ìˆ˜ì • ë°©ë²•:</strong> ${violation.fix_action}</div>`;
                    }
                    
                    html += '</div>';
                });
                html += '</div>';
            }
            
            // ë©”ì‹œì§€ê°€ ìˆëŠ” ê²½ìš° (íŒŒì‹± ì‹¤íŒ¨ ë“±)
            if (result.message) {
                html += `<div class="section-subtitle">ğŸ“„ ë©”ì‹œì§€</div>`;
                html += `<div style="padding: 8px; background: var(--figma-color-bg-secondary); border-radius: 4px; margin-bottom: 12px;">${result.message}</div>`;
            }
            
            // ì›ë³¸ ë¶„ì„ ê²°ê³¼ê°€ ìˆëŠ” ê²½ìš° (íŒŒì‹± ì‹¤íŒ¨ì‹œ)
            if (result.raw_analysis) {
                html += `<div class="section-subtitle">ğŸ“„ ì›ë³¸ ë¶„ì„ ê²°ê³¼</div>`;
                html += `<pre style="background: var(--figma-color-bg-secondary); padding: 8px; border-radius: 4px; font-size: 10px; max-height: 200px; overflow-y: auto; white-space: pre-wrap;">${result.raw_analysis}</pre>`;
            }
            
            html += '</div>';
            return html;
        }
        
        // ê²°ê³¼ í‘œì‹œ
        function displayResult(result) {
            try {
                let htmlContent;
                
                // ë””ë²„ê¹… ì •ë³´ê°€ ìˆëŠ” ê²½ìš° (íŒŒì‹± ì‹¤íŒ¨ ë“±)
                if (result.raw_response && result.parse_error) {
                    htmlContent = `
                        <div class="result error">
                            <h3>âš ï¸ JSON íŒŒì‹± ì˜¤ë¥˜</h3>
                            <p><strong>íŒŒì‹± ì—ëŸ¬:</strong> ${result.parse_error}</p>
                            <br>
                            <p><strong>ì›ë³¸ ì‘ë‹µ:</strong></p>
                            <pre style="background: var(--figma-color-bg-secondary); padding: 8px; border-radius: 4px; font-size: 10px; max-height: 200px; overflow-y: auto;">${result.raw_response}</pre>
                        </div>
                    `;
                } else if (typeof result === 'string') {
                    // ë¬¸ìì—´ì¸ ê²½ìš° JSON íŒŒì‹± ì‹œë„
                    try {
                        const parsed = JSON.parse(result);
                        htmlContent = formatAnalysisResult(parsed);
                    } catch (e) {
                        htmlContent = `
                            <div class="result">
                                <h3>ğŸ“‹ ì‘ë‹µ ë‚´ìš©</h3>
                                <pre style="background: var(--figma-color-bg-secondary); padding: 8px; border-radius: 4px; font-size: 10px; max-height: 200px; overflow-y: auto;">${result}</pre>
                            </div>
                        `;
                    }
                } else if (typeof result === 'object' && result !== null) {
                    // ê°ì²´ì¸ ê²½ìš° êµ¬ì¡°í™”ëœ í‘œì‹œ
                    htmlContent = formatAnalysisResult(result);
                } else {
                    htmlContent = `
                        <div class="result">
                            <h3>ğŸ“‹ ì‘ë‹µ ë‚´ìš©</h3>
                            <pre style="background: var(--figma-color-bg-secondary); padding: 8px; border-radius: 4px; font-size: 10px;">${String(result)}</pre>
                        </div>
                    `;
                }
                
                elements.resultContent.innerHTML = htmlContent;
            } catch (error) {
                elements.resultContent.innerHTML = `<div class="result error">ê²°ê³¼ í‘œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
            }
        }
        
        // ì—ëŸ¬ í‘œì‹œ
        function displayError(errorMessage) {
            elements.resultContent.innerHTML = `<div class="result error">âŒ ${errorMessage}</div>`;
        }
        
        // ë©”ì‹œì§€ ìˆ˜ì‹  ì²˜ë¦¬
        window.onmessage = (event) => {
            const { type, payload } = event.data.pluginMessage || {};
            
            switch (type) {
                case 'SELECTION_INFO':
                    updateSelectionInfo(payload);
                    break;
                    
                case 'ANALYSIS_LOADING':
                    setLoading(payload);
                    break;
                    
                case 'ANALYSIS_RESULT':
                    displayResult(payload);
                    break;
                    
                case 'ANALYSIS_ERROR':
                    displayError(payload);
                    break;
            }
        };
        
        // ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        elements.refreshBtn.onclick = () => {
            parent.postMessage({ 
                pluginMessage: { type: 'REQUEST_SELECTION' } 
            }, '*');
        };
        
        elements.analyzeBtn.onclick = () => {
            if (isAnalyzing) return;
            
            parent.postMessage({ 
                pluginMessage: { type: 'RUN_ANALYSIS' } 
            }, '*');
        };
        
        elements.closeBtn.onclick = () => {
            parent.postMessage({ 
                pluginMessage: { type: 'CLOSE_PLUGIN' } 
            }, '*');
        };
        
        // ì´ˆê¸° ì„ íƒ ì •ë³´ ìš”ì²­
        parent.postMessage({ 
            pluginMessage: { type: 'REQUEST_SELECTION' } 
        }, '*');
</script>
</body>
</html>
